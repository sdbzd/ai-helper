# 多用户移动应用代理系统 - 架构草案

## 1. 总览
- App1 (Tauri) = UI + 脚本管理 + 安全存储 + 自动化编排
- 自动化引擎 = Web/Android/iOS 驱动 + 验证码处理 + 沙箱运行
- 安全存储 = 平台密钥管理 (Keystore/Keychain) + 加密凭证库
- IPC/侧载进程 = 隔离自动化执行，主进程仅持有最小权限

## 2. 模块职责
- UI/主进程：账户管理、脚本编辑/测试、任务触发、状态通知
- 自动化服务进程：解析脚本、调度驱动、处理验证码、生成会话令牌
- 脚本管理器：录制/编辑/校验/版本管理/共享导入导出
- 安全存储：凭证加密、密钥轮换、零化、备份恢复
- 平台适配层：Web(Playwright) / Android(Accessibility) / iOS(XCUITest)

## 3. 数据流 (登录)
1. 用户在 UI 选择目标 App2 账户 -> 读取凭证 (解封装密钥需生物识别)
2. 选择/编辑脚本 -> IPC 发送给自动化服务
3. 自动化服务按脚本执行：
   - 按目标类型选择驱动
   - 遇到验证码时委托验证码处理管线(OCR/第三方/人工)
   - 收集验证条件 -> 成功返回会话令牌
4. 会话令牌返回主进程 -> 缓存/展示/上游 API 使用
5. 审计与日志记录：任务状态、异常、重试

## 4. 安全设计
- 密钥与凭证：硬件密钥库生成/派生，AES-GCM 加密，敏感内存零化
- 进程隔离：自动化在侧载沙箱进程运行，仅通过受限 IPC 交互
- RBAC：主账户/子账户/委派授权；操作审计和最小权限
- 网络安全：TLS pinning（对第三方识别服务），请求签名与速率控制
- 隐私防护：屏幕遮挡敏感字段、日志脱敏、崩溃转储剔除密文

## 5. 扩展性与演进
- 驱动插件化：增加新平台或浏览器仅需实现 `AutomationDriver`
- 验证码策略可插拔：策略表驱动 + 成本/成功率决策
- 脚本格式前向兼容：版本号 + schema 校验 + 迁移器
- 观测性：统一 tracing + 指标导出 (执行时延、成功率、验证码成本)
- 未来演进：加入远程分布式执行、脚本市场、策略 AB 实验

